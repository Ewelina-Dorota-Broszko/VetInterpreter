<div class="dashboard-menu-container">
  <div class="container">

    <div class="bar">
      <div class="left">
        <h2>Klienci</h2>
      </div>
      <div class="right small-nav">
        <a routerLink="/admin/vets" class="ghost" routerLinkActive="active">Weterynarze</a>
      </div>
    </div>

<div class="filters">
  <input type="text" placeholder="Szukaj (nazwa, email, telefon…)" [(ngModel)]="q" (keyup.enter)="onSearch()">
  <button (click)="onSearch()">Szukaj</button>
  <button class="ghost" (click)="showAll()">Pokaż wszystkich</button>

  <div class="spacer"></div>

  <label>Na stronę:
    <select [(ngModel)]="limit" (change)="onLimitChange()">
      <option *ngFor="let l of limits" [value]="l">{{ l }}</option>
    </select>
  </label>
</div>



    <div *ngIf="loading" class="muted">Ładowanie…</div>
    <p class="error" *ngIf="!loading && error">{{ error }}</p>

    <ng-container *ngIf="!loading && !error">
      <p class="muted" *ngIf="!rows.length">Brak wyników.</p>

      <table *ngIf="rows.length">
        <thead>
          <tr>
            <th>Klient</th>
            <th>Telefon</th>
            <th>Email</th>
            <th>User ID</th>
            <th>Ostatnie logowanie</th>
            <th>Zwierzęta</th>
            <th class="center">Akcje</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of rows; trackBy: trackByOwnerId">
            <td>{{ r.name || '—' }}</td>
            <td>{{ r.phone || '—' }}</td>
            <td><a [href]="'mailto:'+r.email">{{ r.email }}</a></td>
            <td class="mono">{{ r.userId }}</td>
            <td>{{ r.lastLoginAt ? (r.lastLoginAt | date:'yyyy-MM-dd HH:mm') : '—' }}</td>
            <td>
              <button class="ghost small" (click)="toggleExpand(r)">
                {{ r._expanded ? 'Ukryj' : 'Pokaż' }} ({{ r.animalsCount || (r.animals?.length || 0) }})
              </button>
            </td>
            <td class="center">
              <div class="row-actions">
                <button class="ghost" (click)="togglePass(r)">{{ r._editingPass ? 'Anuluj' : 'Zmień hasło' }}</button>
                <button class="danger" (click)="deleteOwner(r)" [disabled]="r._busy">Usuń</button>
              </div>

              <div class="pass-editor" *ngIf="r._editingPass">
                <input type="password" placeholder="Nowe hasło (min 6)" [(ngModel)]="r._newPass">
                <button (click)="resetPass(r)" [disabled]="r._busy">Zapisz</button>
              </div>
            </td>
          </tr>

          <!-- wiersz szczegółów: zwierzęta klienta -->
          <tr *ngFor="let r of rows; trackBy: trackByOwnerId">
            <td colspan="7" *ngIf="r._expanded">
              <div class="animals">
                <table class="subtable" *ngIf="r.animals?.length; else noAnimals">
                  <thead>
                    <tr>
                      <th>Nazwa</th>
                      <th>Gatunek</th>
                      <th>Rasa</th>
                      <th>Płeć</th>
                      <th>Waga [kg]</th>
                      <th>Data ur.</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let a of r.animals; trackBy: trackByAnimalId">
                      <td>{{ a.name }}</td>
                      <td>{{ a.species || '—' }}</td>
                      <td>{{ a.breed || '—' }}</td>
                      <td>{{ a.sex || '—' }}</td>
                      <td>{{ a.weightKg || '—' }}</td>
                      <td>{{ a.birthDate || '—' }}</td>
                    </tr>
                  </tbody>
                </table>
                <ng-template #noAnimals>
                  <p class="muted">Brak zwierząt.</p>
                </ng-template>
              </div>
            </td>
          </tr>

        </tbody>
      </table>

      <div class="paginator" *ngIf="total > limit">
        <button (click)="prev()" [disabled]="page===1">←</button>
        <span>{{ rangeText() }}</span>
        <button (click)="next()" [disabled]="page*limit>=total">→</button>
      </div>
    </ng-container>

  </div>
</div>
