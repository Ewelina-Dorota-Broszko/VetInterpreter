<div class="dashboard-menu-container" *ngIf="animal">
  <div class="container">

    <!-- Pasek akcji nad profilem -->
    <div class="action-animal">
      <div *ngIf="animal.vetId; else noVet" class="your-vet">
        <p>Przypisany wet:</p>
        <button type="button" class="ghost" (click)="openVetModal(animal.vetId)">zobacz profil</button>
        <button type="button" class="ghost" (click)="unassignVet()">Odepnij</button>
      </div>
      <button type="button" class="danger" (click)="onDeleteAnimal()" [disabled]="deleting">
        {{ deleting ? 'Usuwanie…' : 'Usuń zwierzaka' }}
      </button>
    </div>

    <ng-template #noVet>
      <div class="my-vet">
        <p>Brak przypisanego weta.</p>
        <button type="button" (click)="goAssignVet()">Przypisz weterynarza</button>
      </div>
    </ng-template>

    <!-- ===== Historia wizyt (bez filtra – zwykle to notatki weta) ===== -->
    <section class="visit-history" *ngIf="(animal.visitHistory?.length ?? 0) > 0">
      <h3>Historia wizyt</h3>

      <div *ngFor="let visit of animal.visitHistory; trackBy: trackByIndex" class="visit-card">
        <div class="visit-summary" (click)="toggleDetails(visit)">
          <strong>{{ visit.visitDate }}</strong>
          – {{ visit.clinicName }} ({{ visit.vetName }})
          <span *ngIf="visit.nextVisitDate"> | Następna: {{ visit.nextVisitDate }}</span>
        </div>

        <div class="visit-details" *ngIf="visit.expanded">
          <p><strong>Objawy:</strong> {{ visit.symptoms || '—' }}</p>
          <p><strong>Leczenie:</strong> {{ visit.treatments || '—' }}</p>

          <div *ngIf="(visit.medications?.length ?? 0) > 0">
            <strong>Leki:</strong>
            <ul>
              <li *ngFor="let med of visit.medications">
                {{ med.name }} – {{ med.dosage }} – {{ med.frequency }}
              </li>
            </ul>
          </div>

          <p><strong>Notatki:</strong> {{ visit.notes || '—' }}</p>
        </div>
      </div>
    </section>

    <!-- ===== Nagłówek profilu ===== -->
    <div class="profile-wrapper">
      <header class="header">
        <div class="info">
          <h1>{{ animal.name }}</h1>
          <p *ngIf="animal.ownerName">Właściciel: <strong>{{ animal.ownerName }}</strong></p>
          <p>
            Gatunek: <strong>{{ animal.species }}</strong>
            <span *ngIf="animal.breed"> | Rasa: <strong>{{ animal.breed }}</strong></span>
          </p>
          <p>
            Płeć: <strong>{{ animal.sex }}</strong>
            <span *ngIf="animal.weightKg"> | Waga: <strong>{{ animal.weightKg }} kg</strong></span>
          </p>
          <p *ngIf="getAgeYears() !== null">Wiek: <strong>{{ getAgeYears() }} lat</strong></p>

          <!-- FILTR wpisów (klient może obejrzeć tylko swoje / tylko wetów / wszystkie) -->
          <div class="scope-filter" style="margin-top: 8px;">
            <label>
              Pokaż wpisy:
              <select [(ngModel)]="scope" (change)="onScopeChange()">
                <option value="all">Wszystkie</option>
                <option value="owner">Tylko moje</option>
                <option value="vet">Tylko weterynarzy</option>
              </select>
            </label>
            <span class="muted small" style="margin-left: 8px;">
              Filtr: <strong>{{ scopeLabel[scope] }}</strong>
            </span>
          </div>
        </div>

        <div class="actions">
          <button type="button" (click)="addNewDocument()">Dodaj nowy dokument</button>
        </div>
      </header>

      <!-- ===== Zakładki ===== -->
      <nav class="tabs">
        <button [class.active]="activeTab === 'overview'" (click)="setTab('overview')">Podsumowanie</button>
        <button [class.active]="activeTab === 'blood'" (click)="setTab('blood')">Krew</button>
        <button [class.active]="activeTab === 'urine'" (click)="setTab('urine')">Mocz</button>
        <button [class.active]="activeTab === 'stool'" (click)="setTab('stool')">Kał</button>
        <button [class.active]="activeTab === 'temperature'" (click)="setTab('temperature')">Temperatura</button>
        <button [class.active]="activeTab === 'diabetes'" (click)="setTab('diabetes')">Cukrzyca</button>
        <button [class.active]="activeTab === 'weight'" (click)="setTab('weight')">Waga & BCS</button>
        <button [class.active]="activeTab === 'vaccinations'" (click)="setTab('vaccinations')">Szczepienia</button>
        <button [class.active]="activeTab === 'meds'" (click)="setTab('meds')">Leki</button>
        <button [class.active]="activeTab === 'symptoms'" (click)="setTab('symptoms')">Objawy</button>
      </nav>

      <!-- ===== Badania krwi ===== -->
      <section *ngIf="activeTab === 'blood'" class="tab-content">
        <ng-container *ngIf="(bloodTestsFiltered?.length ?? 0) > 0; else bloodEmpty">
          <app-blood-tab
            [bloodTests]="bloodTestsFiltered"
            [referenceRanges]="referenceRanges">
          </app-blood-tab>
        </ng-container>
        <ng-template #bloodEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Badania moczu ===== -->
      <section *ngIf="activeTab === 'urine'" class="tab-content">
        <ng-container *ngIf="(urineTestsFiltered?.length ?? 0) > 0; else urineEmpty">
          <app-urine-tab [urineTests]="urineTestsFiltered"></app-urine-tab>
        </ng-container>
        <ng-template #urineEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Badania kału ===== -->
      <section *ngIf="activeTab === 'stool'" class="tab-content">
        <ng-container *ngIf="(stoolTestsFiltered?.length ?? 0) > 0; else stoolEmpty">
          <app-stool-tab [stoolTests]="stoolTestsFiltered"></app-stool-tab>
        </ng-container>
        <ng-template #stoolEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Pomiary temperatury ===== -->
      <section *ngIf="activeTab === 'temperature'" class="tab-content">
        <ng-container *ngIf="(temperatureLogsFiltered?.length ?? 0) > 0; else tempEmpty">
          <app-temperature-tab [temperatureLogs]="temperatureLogsFiltered"></app-temperature-tab>
        </ng-container>
        <ng-template #tempEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Cukrzyca ===== -->
      <section *ngIf="activeTab === 'diabetes'" class="tab-content">
        <ng-container *ngIf="(diabetesLogsFiltered?.length ?? 0) > 0; else diabetesEmpty">
          <app-diabetes-tab [diabetesLogs]="diabetesLogsFiltered"></app-diabetes-tab>
        </ng-container>
        <ng-template #diabetesEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Waga & BCS ===== -->
      <section *ngIf="activeTab === 'weight'" class="tab-content">
        <ng-container *ngIf="(weightHistoryFiltered?.length ?? 0) > 0; else weightEmpty">
          <app-weight-tab [weightHistory]="weightHistoryFiltered"></app-weight-tab>
        </ng-container>
        <ng-template #weightEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Szczepienia ===== -->
      <section *ngIf="activeTab === 'vaccinations'" class="tab-content">
        <ng-container *ngIf="(vaccinationsFiltered?.length ?? 0) > 0; else vaccEmpty">
          <app-vaccinations-tab [vaccinations]="vaccinationsFiltered"></app-vaccinations-tab>
        </ng-container>
        <ng-template #vaccEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Leki ===== -->
      <section *ngIf="activeTab === 'meds'" class="tab-content">
        <ng-container *ngIf="(medicationsFiltered?.length ?? 0) > 0; else medsEmpty">
          <app-meds-tab [animalId]="animal?._id" [medications]="medicationsFiltered"></app-meds-tab>
        </ng-container>
        <ng-template #medsEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>

      <!-- ===== Objawy ===== -->
      <section *ngIf="activeTab === 'symptoms'" class="tab-content">
        <ng-container *ngIf="(symptomsFiltered?.length ?? 0) > 0; else symptomsEmpty">
          <app-symptoms-tab [symptoms]="symptomsFiltered"></app-symptoms-tab>
        </ng-container>
        <ng-template #symptomsEmpty>
          <p class="muted">Brak danych w wybranym filtrze.</p>
        </ng-template>
      </section>
    </div>
  </div>
</div>

<!-- Gdy brak danych zwierzaka -->
<div *ngIf="!animal" class="empty-state">
  Ładuję dane profilu…
</div>

<!-- Popup: profil veta (dla klienta) -->
<app-vet-profile-modal
  *ngIf="showVetModal"
  [vetId]="modalVetId!"
  (close)="closeVetModal()"
></app-vet-profile-modal>
