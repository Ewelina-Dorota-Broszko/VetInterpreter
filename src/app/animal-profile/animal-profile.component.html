<div class="dashboard-menu-container">
  <div class="container">
    <!-- Visit History -->
    <section class="visit-history">
      <h3>Historia wizyt</h3>

      <div *ngFor="let visit of animal.visitHistory" class="visit-card">
        <div class="visit-summary" (click)="toggleDetails(visit)">
          <strong>{{ visit.visitDate }}</strong> – {{ visit.clinicName }} ({{ visit.vetName }})
          <span *ngIf="visit.nextVisitDate"> | Następna: {{ visit.nextVisitDate }}</span>
        </div>

        <div class="visit-details" *ngIf="visit.expanded">
            <p><strong>Objawy:</strong> {{ visit.symptoms || '—' }}</p>
          <p><strong>Leczenie:</strong> {{ visit.treatments || '—' }}</p>

          <div *ngIf="visit.medications?.length">
            <strong>eki:</strong>
            <ul>
              <li *ngFor="let med of visit.medications">
                {{ med.name }} – {{ med.dosage }} – {{ med.frequency }}
              </li>
            </ul>
          </div>

          <p><strong>Notatki:</strong> {{ visit.notes || '—' }}</p>
        </div>
      </div>
    </section>

    <!-- Profile -->
    <div class="profile-wrapper" *ngIf="animal">
      <header class="header">
        <div class="info">
          <h1>{{ animal.name }}</h1>
          <p>Właściciel: <strong>{{ animal.ownerName }}</strong></p>
          <p>Gatunek: <strong>{{ animal.species }}</strong> | Rasa: <strong>{{ animal.breed }}</strong></p>
          <p>Płeć: <strong>{{ animal.sex }}</strong> | Waga: <strong>{{ animal.weightKg }} kg</strong></p>
          <p *ngIf="getAgeYears() !== null">Wiek: <strong>{{ getAgeYears() }} lat</strong></p>
        </div>

        <div class="actions">
          <button (click)="addNewDocument()">Dodaj nowy dokument</button>
        </div>
      </header>

      <!-- Tabs -->
    <nav class="tabs">
        <button [class.active]="activeTab === 'overview'" (click)="setTab('overview')">Podsumowanie</button>
        <button [class.active]="activeTab === 'blood'" (click)="setTab('blood')">Krew</button>
        <button [class.active]="activeTab === 'urine'" (click)="setTab('urine')">Mocz</button>
        <button [class.active]="activeTab === 'stool'" (click)="setTab('stool')">Kał</button>
        <button [class.active]="activeTab === 'temperature'" (click)="setTab('temperature')">Temperatura</button>
        <button [class.active]="activeTab === 'diabetes'" (click)="setTab('diabetes')">Cukrzyca</button>
      </nav>
      
      <!-- Podsumowanie -->
      <section *ngIf="activeTab === 'overview'" class="tab-content">
        <h2>Podsumowanie</h2>
        <div class="cards">
          <div class="card" *ngIf="latest(animal.bloodTests) as lastBlood">
            <h3>Ostatnie badanie krwi</h3>
            <p>Data: {{ lastBlood.date }}</p>
            <p>HGB: {{ lastBlood.hemoglobin }} g/dL</p>
            <p>WBC: {{ lastBlood.wbc }} 10⁹/L</p>
            <p>Glukoza: {{ lastBlood.glucose }} mg/dL</p>
          </div>
          <div class="card" *ngIf="latest(animal.urineTests) as lastUrine">
            <h3>Ostatnie badanie moczu</h3>
            <p>Data: {{ lastUrine.date }}</p>
            <p>SG: {{ lastUrine.specificGravity }}</p>
            <p>pH: {{ lastUrine.pH }}</p>
            <p>Białko: {{ lastUrine.protein }}</p>
          </div>
          <div class="card" *ngIf="latest(animal.temperatureLogs) as lastTemp">
            <h3>Ostatni pomiar temperatury</h3>
            <p>Data: {{ lastTemp.date }} {{ lastTemp.time }}</p>
            <p>Temp: {{ lastTemp.temperature }} °C</p>
          </div>
          <div class="card" *ngIf="latest(animal.diabetesLogs) as lastDiab">
            <h3>Ostatni zapis cukrzycy</h3>
            <p>Data: {{ lastDiab.date }} {{ lastDiab.time }}</p>
            <p>Glukoza: {{ lastDiab.glucose }} mg/dL</p>
            <p>Typ: {{ lastDiab.measurementType }}</p>
            <p *ngIf="lastDiab.insulinType">Insulina: {{ lastDiab.insulinType }} ({{ lastDiab.insulinDose || 0 }} j.)</p>
          </div>
        </div>
      </section>

      <!-- Blood -->
      <section *ngIf="activeTab === 'blood'" class="tab-content">
        <h2>Badania krwi</h2>

        <!-- Wykres liniowy -->
        <canvas id="bloodChart" *ngIf="animal.bloodTests.length"></canvas>

        <!-- Tabela -->
        <table *ngIf="animal.bloodTests.length; else noBlood">
          <thead>
            <tr>
              <th>Data</th>

              <!-- Morfologia -->
              <th>HGB</th>
              <th>RBC</th>
              <th>WBC</th>
              <th>Hematokryt</th>
              <th>Płytki</th>
              <th>MCV</th>
              <th>MCH</th>
              <th>MCHC</th>

              <!-- Biochemia -->
              <th>Glukoza</th>
              <th>Mocznik</th>
              <th>Kreatynina</th>
              <th>ALT (GPT)</th>
              <th>AST (GOT)</th>
              <th>ALP</th>
              <th>Białko całkowite</th>
              <th>Albuminy</th>
              <th>Globuliny</th>
              <th>Bilirubina całkowita</th>
              <th>Bilirubina bezpośrednia</th>
              <th>Bilirubina pośrednia</th>

              <!-- Inne -->
              <th>Komentarz</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let test of animal.bloodTests; trackBy: trackByIndex">
              <td>{{ test.date }}</td>

              <!-- Morphology -->
              <td [ngClass]="getValueStatus(test.hemoglobin, 'hemoglobin')">
                {{ test.hemoglobin }}<br>
                <small class="ref-range">{{ getRangeText('hemoglobin') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.rbc, 'rbc')">
                {{ test.rbc }}<br>
                <small class="ref-range">{{ getRangeText('rbc') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.wbc, 'wbc')">
                {{ test.wbc }}<br>
                <small class="ref-range">{{ getRangeText('wbc') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.hematocrit, 'hematocrit')">
                {{ test.hematocrit }}<br>
                <small class="ref-range">{{ getRangeText('hematocrit') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.platelets, 'platelets')">
                {{ test.platelets }}<br>
                <small class="ref-range">{{ getRangeText('platelets') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.mcv, 'mcv')">
                {{ test.mcv }}<br>
                <small class="ref-range">{{ getRangeText('mcv') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.mch, 'mch')">
                {{ test.mch }}<br>
                <small class="ref-range">{{ getRangeText('mch') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.mchc, 'mchc')">
                {{ test.mchc }}<br>
                <small class="ref-range">{{ getRangeText('mchc') }}</small>
              </td>

              <!-- Biochemistry -->
              <td [ngClass]="getValueStatus(test.glucose, 'glucose')">
                {{ test.glucose }}<br>
                <small class="ref-range">{{ getRangeText('glucose') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.urea, 'urea')">
                {{ test.urea }}<br>
                <small class="ref-range">{{ getRangeText('urea') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.creatinine, 'creatinine')">
                {{ test.creatinine }}<br>
                <small class="ref-range">{{ getRangeText('creatinine') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.alt, 'alt')">
                {{ test.alt }}<br>
                <small class="ref-range">{{ getRangeText('alt') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.ast, 'ast')">
                {{ test.ast }}<br>
                <small class="ref-range">{{ getRangeText('ast') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.alp, 'alp')">
                {{ test.alp }}<br>
                <small class="ref-range">{{ getRangeText('alp') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.totalProtein, 'totalProtein')">
                {{ test.totalProtein }}<br>
                <small class="ref-range">{{ getRangeText('totalProtein') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.albumin, 'albumin')">
                {{ test.albumin }}<br>
                <small class="ref-range">{{ getRangeText('albumin') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.globulin, 'globulin')">
                {{ test.globulin }}<br>
                <small class="ref-range">{{ getRangeText('globulin') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.bilirubinTotal, 'bilirubinTotal')">
                {{ test.bilirubinTotal }}<br>
                <small class="ref-range">{{ getRangeText('bilirubinTotal') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.bilirubinDirect, 'bilirubinDirect')">
                {{ test.bilirubinDirect }}<br>
                <small class="ref-range">{{ getRangeText('bilirubinDirect') }}</small>
              </td>
              <td [ngClass]="getValueStatus(test.bilirubinIndirect, 'bilirubinIndirect')">
                {{ test.bilirubinIndirect }}<br>
                <small class="ref-range">{{ getRangeText('bilirubinIndirect') }}</small>
              </td>

              <!-- Comments -->
              <td>{{ test.comments || '—' }}</td>
            </tr>

          </tbody>
        </table>

        <ng-template #noBlood>
            <p>Brak badań krwi.</p>
        </ng-template>
      </section>


      <!-- Urine -->
      <section *ngIf="activeTab === 'urine'" class="tab-content">
        <h2>Badania moczu</h2>
        <table *ngIf="animal.urineTests.length; else noUrine">
          <thead>
            <tr>
              <th>Data</th>
              <th>Kolor</th>
              <th>SG</th>
              <th>pH</th>
              <th>Białko</th>
              <th>Glukoza</th>
              <th>Ciała ketonowe</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let test of animal.urineTests; trackBy: trackByIndex">
              <td>{{ test.date }}</td>
              <td>{{ test.color }}</td>
              <td>{{ test.specificGravity }}</td>
              <td>{{ test.pH }}</td>
              <td>{{ test.protein }}</td>
              <td>{{ test.glucose }}</td>
              <td>{{ test.ketones }}</td>
            </tr>
          </tbody>
        </table>

        <ng-template #noUrine>
          <p>Brak badań moczu.</p>
        </ng-template>
      </section>

      <!-- Stool -->
      <section *ngIf="activeTab === 'stool'" class="tab-content">
       <h2>Badania kału</h2>
        <table *ngIf="animal.stoolTests.length; else noStool">
          <thead>
            <tr>
              <th>Data</th>
              <th>Konsystencja</th>
              <th>Kolor</th>
              <th>Krew</th>
              <th>Śluz</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let test of animal.stoolTests; trackBy: trackByIndex">
              <td>{{ test.date }}</td>
              <td>{{ test.consistency }}</td>
              <td>{{ test.color }}</td>
              <td>{{ test.blood ? 'yes' : 'no' }}</td>
              <td>{{ test.mucus ? 'yes' : 'no' }}</td>
            </tr>
          </tbody>
        </table>

        <ng-template #noStool>
          <p>Brak badań kału.</p>
        </ng-template>
      </section>

      <!-- Temperature -->
      <section *ngIf="activeTab === 'temperature'" class="tab-content">
         <h2>Pomiary temperatury</h2>
        <canvas id="temperatureChart" *ngIf="animal.temperatureLogs.length"></canvas>

        <table *ngIf="animal.temperatureLogs.length; else noTemp">
          <thead>
            <tr>
              <th>Data</th>
              <th>Godzina</th>
              <th>Temperatura (°C)</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of animal.temperatureLogs; trackBy: trackByIndex">
              <td>{{ t.date }}</td>
              <td>{{ t.time }}</td>
              <td>{{ t.temperature }}</td>
            </tr>
          </tbody>
        </table>

        <ng-template #noTemp>
          <p>Brak zapisów temperatury.</p>
        </ng-template>
      </section>

      <!-- Diabetes -->
      <section *ngIf="activeTab === 'diabetes'" class="tab-content">
        <h2>Diabetes logs</h2>
        <table *ngIf="animal.diabetesLogs.length; else noDiab">
          <thead>
            <tr>
              <th>Data</th>
              <th>Godzina</th>
              <th>Glukoza (mg/dL)</th>
              <th>Typ</th>
              <th>Insulina</th>
              <th>Dawka (j.)</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of animal.diabetesLogs; trackBy: trackByIndex">
              <td>{{ d.date }}</td>
              <td>{{ d.time }}</td>
              <td>{{ d.glucose }}</td>
              <td>{{ d.measurementType }}</td>
              <td>{{ d.insulinType || '-' }}</td>
              <td>{{ d.insulinDose || '-' }}</td>
            </tr>
          </tbody>
        </table>

        <ng-template #noDiab>
           <p>Brak zapisów cukrzycy.</p>
        </ng-template>
      </section>
    </div>

    <app-calendar></app-calendar>

  </div>
</div>